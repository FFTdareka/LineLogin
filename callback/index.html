<!DOCTYPE html>
<html>
  <head>
    <title>LINE ログインテスト</title>
  </head>
  <body>
    <script type="text/javascript">
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      fetch('https://api.line.me/oauth2/v2.1/token', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({
          grant_type: 'authorization_code',
          code: code,
          redirect_uri: "https://fftdareka.github.io/LineLogin/callback",
          client_id: "2006030047",
          client_secret: "41e68957a7180b6101c6fab87039b1ca"
        })
      })
      .then(response => response.json())
      .then(data => {
        let token = data.id_token;
        let tokenData = token.split(".");
        tokenData.shift();
        tokenData.pop();
        tokenData = JSON.parse(decodeURIComponent(escape(atob(tokenData.toString()))));
        let uid = tokenData.sub;
        let uname = tokenData.name;
        let p = document.createElement("p");
        p.innerText = "uid: " + uid + "   uname: " + uname;
        document.body.appendChild(p);
        let h = {
          "Content-Type" : "application/json; charset=UTF-8",
          'Authorization': 'Bearer hD62Qedoe4G4YXNJUhQXG6nIYcCJ0PQfGPgKXUNfgmrGjPyQOCMdWZffZ7WnYpI+w0iNHcfQHNMCfaXgZAJEjFJ24NCeFVZ3AanlZqtf2wnA06Uxv+5r2dM0+8YitfJGs7yJ2Ht/Fu0JQ2xkWXblagdB04t89/1O/w1cDnyilFU=',
        };
        let p = {
          "to" : "Ue4f4b7f7f98092cb8d80d9f57ca66616",
          "messages" : [
            {
              'type':'text',
              'text': uname,
            }
          ]
        };
        let o = {
          "method" : "post",
          "headers" : h,
          "payload" : JSON.stringify(p)
        };
        UrlFetchApp.fetch("https://api.line.me/v2/bot/message/push", o);
      })
      .catch(error => console.error('Error:', error));
    </script>
  </body>
</html>
